= Antora's Hands-on
:project-name: antora-mini-ted-talk
:url-repo: https://github.com/camptocamp/{project-name}
:antora-docs-url: https://docs.antora.org/antora/2.3/
:github-url: https://github.com/
:antora-nav-page-url: https://docs.antora.org/antora/2.3/navigation/files-and-lists/#whats-a-nav-file

To illustrate the possibilities of the {antora-docs-url}[Antora Tool] in {github-url}[Github], we'll create a first project together.

IMPORTANT: You need to https://docs.antora.org/antora/2.3/install/install-antora/[install antora] if you want to generate your documentation locally.

== Initialize your project

After creating and cloning a new Github project, we will create our first documentation page.
All documentation pages should be written under the `docs` directory, and has to be part of a module.

The default module is named `ROOT`, that's the one we're gonna use as a start.

CAUTION: All command lines in this tutorial rely on the fact that your current directory is the ROOT of your github's repo clone.

[source,shell]
----
# Create docs directory
mkdir docs

# Create a ROOT module directory
mkdir -p docs/modules/ROOT
----

== Create index page

In this module we will create the default page named `index.adoc`. This file has to be placed in a `pages` subdirectory of the module.

[source,shell]
----
# Create pages directory
mkdir -p docs/modules/ROOT/pages

# Initialize an empty new index file
touch docs/modules/ROOT/pages/index.adoc
----

the content of the `index.adoc` should use the https://asciidoc.org/[Asciidoc] syntax. Use the following code snippet to initialize this file :

[source,asciidoc]
----
= Document's title (Level 0)
Author Name <author.name@camptocamp.com>
:description: This is a description.
:keywords: antora, asciidoc
:sectanchors:
:url-repo: https://github.com/NAME_OF_YOUR_PROJECT

{url-repo}[This repository] contains the my test code for this Antora's Hands-on.

video::BAJ8F7yQz64[youtube]
----

NOTE: Every file with `adoc` extension inside the `pages` subdirectory will generate a HTML page in the documentation produced by Antora

== Initialize the navigation file

We will know initialize a {antora-nav-page-url}[navigation file] which will allow us to include the index page in the resulting website.

[source,shell]
----
# Initialize an empty navigation file
touch docs/modules/ROOT/nav.adoc
----

the content of the `nav.adoc` should be structure as a list of references, use this snippet to initialize yours

[source,asciidoc]
----
* xref:index.adoc[Introduction]
----

== Initialize Antora's configuration

Antora relies on a `antora.yml` configuration file that should be place at the root of the `docs\` directory

[source,shell]
----
# Initialize an empty antora configuration file
touch docs/antora.yml
----

the content of the `antora.yml` should use the yaml syntax, use this snippet to initialize yours:

[source,yaml]
----
name: NAME_OF_YOUR_DOC
title: YOURTITLE_OF_YOUR_DOC_DOC_TITLE
version: 0.0.0
nav:
- modules/ROOT/nav.adoc
----

== Initialize configuration of the Antora build

[source,shell]
----
# Initialize an empty navigation file
touch antora-playbook.yml
----

[source,yaml]
----
site:
  title: TITLE_OF_YOUR_DOC
  # the 404 page and sitemap files only get generated when the url property is set
  url: https://github.com/NAME_OF_YOUR_PROJECT
  start_page: NAME_OF_YOUR_DOC::index.adoc
content:
  sources:
  - url: ./
    branches: HEAD
    edit_url: false
    start_path: docs
ui:
  bundle:
    # Use camptocamp's UI bundle
    # url: https://github.com/camptocamp/antora-ui/releases/download/LATEST/ui-bundle.zip
    # You can also use the default Antora UI if you prefer
    url: https://gitlab.com/antora/antora-ui-default/-/jobs/artifacts/master/raw/build/ui-bundle.zip?job=bundle-stable
    snapshot: true
  supplemental_files:
  # Special setup to disable jekyll from github which messes up with the Theme of the resulting website
  - path: ui.yml
    contents: |
      static_files: [ .nojekyll ]
  - path: .nojekyll
----

== Generate your website locally


[source,shell,subs="attributes"]
.generate the site and open it in Chromium
----
antora antora-playbook.yml
chromium build/site/index.html # Adapt if you don't use chromium as a web browser
----

== Automate your Antora build using Github action and publish on Github Pages

It is very easy to automate the building and publishing of your documentation using Github Actions. 

[source,shell]
----
# Create the github workflows directory
mkdir -p .github/workflows
# Generate an empty Github Action
touch .github/workflows/antoradoc.yml
----

For the Github Action, use the following code snippet which does NOT require any modification to work:

[source,yaml]
----
name: Antora Doc 
on:
  push:
    branches:
      # Be careful here, master was renamed to main by default
      - main
env:
  SITE_DIR: 'site'
jobs:
  build_site:
    name: "Build site with Antora"
    runs-on: [ubuntu-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: "Generate site using antora site action"
        uses: kameshsampath/antora-site-action@master
        with:
          antora_playbook: antora-playbook.yml
      - name: "List folder"
        run: |
          ls -ltr $GITHUB_WORKSPACE/build/
      - name: "Upload generated site"
        uses: actions/upload-artifact@v1.0.0
        with:
          name: site
          path: "${{ github.workspace }}/build/${{ env.SITE_DIR }}"
  deploy_site:
    runs-on: [ubuntu-latest]
    needs: [build_site]
    name: "Deploy GitHub Pages"
    steps:
     - name: Setup Node.js for use with actions
       uses: actions/setup-node@v1.1.0
       with:
         version: 12.x
     - name: Checkout
       uses: actions/checkout@v2
     - name: Download generated site
       uses: actions/download-artifact@v1
       with:
         name: site
         path: "${{ github.workspace }}/${{ env.SITE_DIR }}"
     - name: Deploy to GitHub Pages
       uses: JamesIves/github-pages-deploy-action@3.2.1
       with:
        # ACCESS_TOKEN: # optional
        GITHUB_TOKEN: "${{ github.token}}"
        FOLDER: "${{ env.SITE_DIR }}"
        BRANCH: 'gh-pages'
        COMMIT_MESSAGE: "[CI] Publish Documentation for ${{ github.sha }}"
----

== Our first test

=== Push our code

At this stage, we should have a fully automated documentation website "build and publish" pipeline.

Let's try it !

[source,shell]
----
# Make sure we won't push to build directory
echo "build/" > .gitignore
# and commit/push our first website
git add .gitignore
git add antora-playbook.yml
git add docs/
git add .github/workflows/antoradoc.yml
git commit -m"Create new Antora documentation"
git push
----

== Setup Github pages

WAIT for end of first Github action run because creating a new gh-pages branch

image::github_actions_p1.png[800,600]

=== using UI

setup ghpage, use gh-pages branch and build from root

image::github_pages_settings.png[800,600]


== Let's go further

=== Create  an additional page in an additional module

[source,shell]
----
# Create pages directory in additional module
mkdir -p docs/modules/additional_module/pages

# Initialize an new additional adoc file
echo -e "= Additional Page Title\n" > docs/modules/additional_module/pages/additional_page.adoc
----

=== add an image in the content

[source,shell]
----
# Create images asset directory in the new module
mkdir -p docs/modules/additional_module/assets/images

# Download an image of Antora in this newly created directory
wget https://assets.gitlab-static.net/uploads/-/system/group/avatar/1984945/antora-gitlab.png --output-document docs/modules/additional_module/assets/images/antora.png

echo "Below this text, we'll display an image of Antora logo which will contain a hyperlink to Antora's gitlab

image::antora.png[link=\"https://gitlab.com/antora\",150,250]

" >> docs/modules/additional_module/pages/additional_page.adoc
----

=== Create a partial page

A https://docs.antora.org/antora/2.3/asciidoc/include-partial/[partial page] is an asciidoc file that can be included in multiple pages.
It won't be processed by Antora and won't produce a HTML file in the resulting documentation.


[source,shell]
----
# Create a partials directory in the new module
mkdir -p docs/modules/additional_module/partials

# Generate an empty partial page
touch docs/modules/additional_module/partials/partial_page.adoc
----

=== Include a notice in the partial

[source,shell]
----
# The partial will contain an "IMPORTANT" message that will be displayed with a Red label
echo -e "\nIMPORTANT: this very important message is part of the partial page\n" > docs/modules/additional_module/partials/partial_page.adoc
----

=== Include the partial in multiples pages

[source,shell]
----
# Include the partial page in the first index page
echo -e '\ninclude::additional_module:partial$partial_page.adoc[]\n' >> docs/modules/ROOT/pages/index.adoc

# Include the partial page in the additional page
echo -e '\ninclude::additional_module:partial$partial_page.adoc[]\n' >> docs/modules/additional_module/pages/additional_page.adoc
----

== Update the navigation file

We'll now update the navigation file to include the additional page
echo -e "* xref:additional_module:additional_page.adoc[Additional Page]" >> docs/modules/ROOT/nav.adoc

The resulting file will look like this 
[source,asciidoc]
----
* xref:index.adoc[Introduction]
* xref:additional_module:additional_page.adoc[Additional Page]
----

== Change Appearance of the resulting Website


== Include external documentations 

To create a meta doc and/or links to other documentations, you can add links to those projects in the `antora-playbook.yml`

try adding :

[source,yaml]
----
  - url: https://github.com/camptocamp/camptocamp-devops-stack
    branches: master
    edit_url: false
    start_path: docs
----

to make your antora-playbook look like 

[source,yaml]
----
site:
  title: TITLE_OF_YOUR_DOC
  # the 404 page and sitemap files only get generated when the url property is set
  url: https://github.com/camptocamp/NAME_OF_YOUR_PROJECT
  start_page: YOUR_DOC_NAME::index.adoc
content:
  sources:
  - url: ./
    branches: HEAD
    edit_url: false
    start_path: docs
  - url: https://github.com/camptocamp/camptocamp-devops-stack
    branches: master
    edit_url: false
    start_path: docs
ui:
  bundle:
    url: https://github.com/camptocamp/antora-ui/releases/download/LATEST/ui-bundle.zip
    # Using a modified version with dark theme for local tests
    #url: https://github.com/acampergue-camptocamp/antora-ui/releases/download/LATEST/ui-bundle.zip
    snapshot: true
  supplemental_files:
  - path: ui.yml
    contents: |
      static_files: [ .nojekyll ]
  - path: .nojekyll
----